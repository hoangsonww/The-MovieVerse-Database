upstream auth_service {
    least_conn;
    server auth-service:8000;
    keepalive 32;
}

upstream user_service {
    least_conn;
    server user-service:8000;
    keepalive 32;
}

upstream movie_service {
    least_conn;
    server movie-service:8000;
    keepalive 32;
}

upstream review_service {
    least_conn;
    server review-service:8000;
    keepalive 32;
}

upstream recommendation_service {
    least_conn;
    server recommendation-service:8000;
    keepalive 32;
}

upstream search_service {
    least_conn;
    server search-service:8000;
    keepalive 32;
}

upstream search_indexer_service {
    least_conn;
    server search-indexer-service:8000;
    keepalive 16;
}

upstream notification_service {
    least_conn;
    server notification-service:8000;
    keepalive 16;
}

upstream metadata_service {
    least_conn;
    server metadata-service:8000;
    keepalive 16;
}

upstream crawler_service {
    least_conn;
    server crawler-service:8000;
    keepalive 8;
}

upstream data_platform_service {
    least_conn;
    server data-platform-service:8000;
    keepalive 8;
}

limit_req_zone $binary_remote_addr zone=perip:10m rate=15r/s;
limit_conn_zone $binary_remote_addr zone=perip_conn:10m;

server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    limit_req zone=perip burst=30 nodelay;
    limit_conn perip_conn 50;

    proxy_http_version 1.1;
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;

    location /healthz {
        add_header Content-Type text/plain;
        return 200 'ok';
    }

    location /auth {
        proxy_pass http://auth_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /users {
        rewrite ^/users/(.*)$ /profiles/$1 break;
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /profiles {
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /movies {
        proxy_pass http://movie_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /reviews {
        proxy_pass http://review_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /recommendations {
        proxy_pass http://recommendation_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /search {
        proxy_pass http://search_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /notifications {
        proxy_pass http://notification_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /search-indexer {
        proxy_pass http://search_indexer_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /metadata {
        proxy_pass http://metadata_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /crawler {
        proxy_pass http://crawler_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /crawl {
        proxy_pass http://crawler_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }

    location /data-platform {
        proxy_pass http://data_platform_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-ID $request_id;
        proxy_next_upstream error timeout http_502 http_503 http_504;
    }
}
